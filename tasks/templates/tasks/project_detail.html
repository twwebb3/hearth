{% extends "base.html" %}

{% block title %}{{ project.name }}{% endblock %}

{% block content %}
{% include "tasks/_subnav.html" with page_title=project.name %}

<div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
  {% if project.color_hex %}<span style="display: inline-block; width: 14px; height: 14px; border-radius: 50%; flex-shrink: 0; background: {{ project.color_hex }};"></span>{% endif %}
  <span style="color: #6b7280;">
    <a href="{% url 'tasks:domain_detail' pk=project.domain.pk %}" style="color: inherit;">{{ project.domain.name }}</a>
  </span>
  <span style="font-size: 11px; text-transform: uppercase; padding: 2px 8px; border-radius: 6px;
    {% if project.status == 'active' %}background: #d1fae5; color: #065f46;
    {% elif project.status == 'paused' %}background: #fef3c7; color: #92400e;
    {% elif project.status == 'complete' %}background: #e0e7ff; color: #3730a3;
    {% else %}background: #e5e7eb; color: #374151;{% endif %}
  ">{{ project.status }}</span>
</div>
{% if project.description %}<p style="margin-top: 4px; color: #6b7280;">{{ project.description }}</p>{% endif %}

{# ── 14-day completion stats ── #}
<div class="card" style="margin: 16px 0 20px;">
  <div style="font-weight: 600; font-size: 14px; margin-bottom: 8px;">Last 14 days ({{ start_14|date:"M j" }} &ndash; {{ today_date|date:"M j" }})</div>
  {% if stats.total %}
  <div style="display: flex; gap: 16px; font-size: 13px; margin-bottom: 8px;">
    <span style="color: #065f46;">{{ stats.completed }} completed</span>
    <span style="color: #b45309;">{{ stats.incomplete }} incomplete</span>
    <span style="color: #6b7280;">{{ stats.skipped }} skipped</span>
    <span style="font-weight: 600;">{{ stats.total }} total</span>
  </div>
  <div style="height: 8px; border-radius: 4px; background: #e5e7eb; overflow: hidden;">
    <div style="height: 100%; width: {{ stats.rate }}%; background: #10b981; border-radius: 4px;"></div>
  </div>
  <div style="font-size: 12px; color: #6b7280; margin-top: 4px;">{{ stats.rate }}% completion rate</div>
  {% else %}
  <div style="font-size: 13px; color: #6b7280;">No instances in this period.</div>
  {% endif %}
</div>

{# ── Add task ── #}
<div class="card" style="margin-bottom: 20px;">
  <details>
    <summary style="cursor: pointer; font-weight: 600; font-size: 14px; user-select: none;">Add task</summary>
    <form method="post" action="{% url 'tasks:project_add_task' pk=project.pk %}" style="margin-top: 12px; display: flex; flex-direction: column; gap: 10px;">
      {% csrf_token %}
      <div style="display: flex; gap: 8px;">
        <label style="flex: 1; display: flex; flex-direction: column; gap: 4px; font-size: 13px; font-weight: 600;">
          Task name
          <input type="text" name="name" required placeholder="e.g. Write unit tests" style="padding: 6px 8px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px;">
        </label>
        <label style="display: flex; flex-direction: column; gap: 4px; font-size: 13px; font-weight: 600;">
          Due date (optional)
          <input type="date" name="due_date" style="padding: 6px 8px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px;">
        </label>
      </div>
      <button type="submit" class="btn-link" style="font-weight: 600; align-self: flex-start;">Add</button>
    </form>
  </details>
</div>

{# ── Upcoming due tasks ── #}
{% if upcoming %}
<h2 style="font-size: 14px; text-transform: uppercase; letter-spacing: 0.5px; color: #374151; margin-bottom: 6px;">
  Upcoming ({{ upcoming|length }})
</h2>
<div style="display: flex; flex-direction: column; gap: 6px; margin-bottom: 24px;">
  {% for t in upcoming %}
  <div class="card" style="display: flex; align-items: center; gap: 10px;">
    <div style="flex: 1; min-width: 0;">
      <div style="font-weight: 600;"><a href="{% url 'tasks:task_detail' task_id=t.pk %}" style="color: inherit; text-decoration: none;">{{ t.name }}</a></div>
    </div>
    <span style="font-size: 13px; color: #b45309; flex-shrink: 0;">{{ t.due_date|date:"M j" }}</span>
    <a href="{% url 'tasks:schedule_edit' task_id=t.pk %}" class="btn-link" style="font-size: 13px; text-decoration: none;">Schedule</a>
  </div>
  {% endfor %}
</div>
{% endif %}

{# ── All active tasks ── #}
<h2 style="font-size: 14px; text-transform: uppercase; letter-spacing: 0.5px; color: #374151; margin-bottom: 6px;">
  Active tasks{% if tasks %} ({{ tasks|length }}){% endif %}
</h2>

{% if tasks %}
<div style="display: flex; flex-direction: column; gap: 6px;">
  {% for t in tasks %}
  <div class="card" style="display: flex; align-items: center; gap: 10px;">
    <div style="flex: 1; min-width: 0;">
      <div style="font-weight: 600;"><a href="{% url 'tasks:task_detail' task_id=t.pk %}" style="color: inherit; text-decoration: none;">{{ t.name }}</a></div>
      {% if t.description %}<div style="font-size: 13px; color: #6b7280;">{{ t.description }}</div>{% endif %}
    </div>
    <div style="display: flex; gap: 8px; font-size: 13px; flex-shrink: 0; align-items: center;">
      {% if t.due_date %}<span style="color: #6b7280;">{{ t.due_date|date:"M j" }}</span>{% endif %}
      {% if t.schedule_rule %}<span style="font-size: 11px; background: #e0e7ff; color: #3730a3; padding: 1px 6px; border-radius: 4px;">scheduled</span>{% endif %}
      <a href="{% url 'tasks:schedule_edit' task_id=t.pk %}" class="btn-link" style="font-size: 13px; text-decoration: none;">Schedule</a>
    </div>
  </div>
  {% endfor %}
</div>
{% else %}
<div class="card" style="text-align: center; color: #6b7280; padding: 24px;">
  No active tasks in this project.
</div>
{% endif %}
{% endblock %}
